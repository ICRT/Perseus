<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8">
<title>Perseus</title>

<link rel="stylesheet" type="text/css" href="ke/css/khan-site.css" />
<link rel="stylesheet" type="text/css" href="ke/css/khan-exercise.css" />
<link rel="stylesheet" type="text/css" href="lib/katex/fonts/fonts.css" />
<link rel="stylesheet/less" type="text/css" href="lib/katex/katex.less" />
<link rel="stylesheet" type="text/css" href="lib/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="lib/mathquill/mathquill.css" />

<link rel="stylesheet/less" type="text/css" href="stylesheets/exercise-content-package/perseus.less" />
<link rel="stylesheet/less" type="text/css" href="stylesheets/perseus-admin-package/editor.less" />
<script>less = {env: 'development', logLevel: 1};</script>
<script src="lib/less.js"></script>

</head>
<body>

<div id="extras" style="display:none;">
    <button id="toJSON">toJSON</button>
    <button id="scorePreview">Score</button>
    <button id="permalink">permalink</button>
    <span>Seed:</span><span id="problemNum"></span>
    <span>Features:</span><span id="enabledFeatures"></span>
</div>

<h2 id='message' style='color:red;'></h2>
<table>
    <tr>
        <td>qid：</td>
        <td>
            <span id='qid'></span>
        </td>
    </tr>
    <tr>
        <td>科目：</td>
        <td>
            <input id='subject'></input>
        </td>
    </tr>
    <tr>
        <td>是否隱藏題目：</td>
        <td>
            <select id='is_hidden'>
                <option value="True">是的</option>
                <option value="False">否。</option>
            </input>
        </td>
    </tr>
    <tr>
        <td>題目來源：</td>
        <td>
            <input id='source'></input>
        </td>
    </tr>
    <tr>
        <td>難度：</td>
        <td>
            <select id='level'>
                <option value="1">簡單</option>
                <option value="2">中等</option>
                <option value="3">進階</option>
            </select>
        </td>
    </tr>
    <tr>
        <td>範圍：</td>
        <td>
            <textarea rows="3" cols="20" id='cover_range'></textarea>
        </td>
    </tr>
    <tr>
        <td>相關影片：</td>
        <td>
            <textarea rows="3" cols="20" id='related_video'></textarea>
        </td>
    </tr>
</table>
<!-- Begin Perseus HTML -->
<div id="perseus-container">
</div>
<!-- End Perseus HTML -->
<button id="save">儲存改變</button>
<button id="quit">取消編輯</button>

<!-- put an empty div here so the margin on the perseus editor has something
to "push against" (without the div, the padding goes off the page, and the
add hint button ends up touching the bottom of the page). -->
<div class="clear"></div>

<script src="lib/jquery.js"></script>
<script src="lib/underscore.js"></script>
<script src="lib/marked.js"></script>
<script src="lib/react-with-addons.js"></script>
<script src="lib/rcss.js"></script>
<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML-full&amp;delayStartupUntil=configured"></script>
<script src="lib/katex/katex.js"></script>
<script src="lib/mathquill/mathquill.js"></script>
<script src="lib/kas.js"></script>

<script>
    var icu = {
        getDecimalFormatSymbols: function() {
            return {
                decimal_separator: ".",
                grouping_separator: ",",
                minus: "-"
            };
        }
    };
    var KhanUtil = {
        debugLog: function() {},
        localeToFixed: function(num, precision) {
            return num.toFixed(precision);
        }
    };
    var Khan = {
        Util: KhanUtil,
        error: function() {},
        query: {debug: ""},
        imageBase: "/ke/images/",
        scratchpad: {
            enable: function() {},
            disable: function() {}
        }
    };
    React.initializeTouchEvents(true);
</script>

<script src="ke/local-only/jed.js"></script>
<script src="ke/local-only/i18n.js"></script>
<script src="ke/local-only/jquery.qtip.js"></script>
<script src="ke/exercises-stub.js"></script>
<script src="ke/local-only/require.js"></script>

<script>
(function() {

requirejs.config({
    waitSeconds: 120
});

// Load khan-exercises modules, then perseus
require(["ke-deps.js"], function() {
    // pre built
    require(["build/perseus-1.js"], initPerseus);

    // pre built with source maps
    // require(["build/perseus.debug.js"], initPerseus);

    // built on demand
    // require(["src/perseus.js"], initPerseus);
});

function initPerseus(Perseus) {

window.Perseus = Perseus;

var defaultQuestion = {
    "question": {
        "content": "[[☃ example-graphie-widget 1]]",
        "widgets": {
            "example-graphie-widget 1": {
                "type": "example-graphie-widget",
                "graded": true,
                "options": {
                    "correct": [
                        -1,
                        -3
                    ],
                    "graph": {
                        "box": [
                            340,
                            340
                        ],
                        "labels": [
                            "x",
                            "y"
                        ],
                        "range": [
                            [
                                -10,
                                10
                            ],
                            [
                                -10,
                                10
                            ]
                        ],
                        "step": [
                            1,
                            1
                        ],
                        "gridStep": [
                            1,
                            1
                        ],
                        "valid": true,
                        "backgroundImage": null,
                        "markings": "grid",
                        "showProtractor": false
                    }
                }
            }
        }
    },
    "answerArea": {
        "type": "multiple",
        "options": {
            "content": "",
            "widgets": {}
        },
        "calculator": false
    },
    "hints": []
};

var editor;
var problemNum = _.random(1, 99);
var enabledFeatures = {
    highlight: true,
    toolTipFormats: true,
    useMathQuill: true
};

$('#toJSON').on('click', function() {
    console.log(JSON.stringify(editor, null, 4));
});
$('#scorePreview').on('click', function() {
    console.log(editor.scorePreview());
});
$('#permalink').on('click', function(e) {
    window.location.hash = "content=" +
        encodeURIComponent(JSON.stringify(editor));
    e.preventDefault();
});

$('#save').on('click',function(e){

    if(question_dic.is_developer == 'True'){
        return_string = "Have-Authorization";}
    if(!question_dic.uploader_id){
        return_string = "No-Uploader-Name";}
    if(!question_dic.is_developer && question_dic.uploader_id != question_dic.user_id){
        return_string = "No-Authorization";}
    else{
        return_string = "Have-Authorization";}


    if (return_string == "No-Authorization" || return_string == "No-Uploader-Name") {
        alert("很抱歉，您沒有權限編輯第" + question_dic.qid +"題。");
    }
    else{
        if (confirm("修改將儲存於資料庫")) {
            is_hidden = $('select#is_hidden').val();
            subject = $('input#subject').val();
            source = $('input#source').val();
            level = $('select#level').val();
            cover_range = $('textarea#cover_range').val();
            related_video = $('textarea#related_video').val();
            question = JSON.stringify(editor);
            host_name = question_dic.host_name;

            $.ajax({
                url: 'http://' + host_name + '/devadmin/questionmanager/save-edit/',
                data:{'qid':question_dic.qid,
                    'is_hidden':is_hidden,
                    'subject':subject,
                    'source':source,
                    'level':level,
                    'cover_range':cover_range,
                    'related_video':related_video,
                    'is_developer':question_dic.is_developer,
                    'secret':question_dic.secret,
                    'iv':question_dic.iv,
                    'question':question
                },
                method:"POST",

                success:function(data){
                    if(data.indexOf('github')===-1 && data.indexOf('localhost')===-1){
                        parent.window.location = data;
                    }
                    else{
                        document.location.href = data;
                        document.location.reload(true);
                    }
                },
                error:function(xhr, ajaxOptions, thrownError){ 
                    alert(xhr.status + " " + thrownError + "\n請檢查連線狀況"); 
                }
            });
            
        }
    }

});
$('#quit').on('click',function(e){
    if (confirm("取消修改的話，未儲存之所有修改將不會儲存")) {
        parent.close();
    }
});

$('#problemNum').text(problemNum);
$('#enabledFeatures').html(_.map(enabledFeatures, function(enabled, feature) {
    return '<span style="margin-left: 5px; background: ' +
            (enabled ? "#aaffaa" : "#ffcccc") + ';">' + feature + '</span>';
}).join(''));


// don't know why!
url = window.location.hash.split('?')[0].substring(1);
var question_dic = Perseus.Util.parseQueryString(url);
var question = question_dic.question ? JSON.parse(question_dic.question) : defaultQuestion;
$('span#qid').html(question_dic.qid);
$('select#is_hidden').val(question_dic.is_hidden);
$('input#subject').val(question_dic.subject);
$('input#source').val(question_dic.source);
$('select#level').val(question_dic.level);
$('textarea#cover_range').val(question_dic.cover_range);
$('textarea#related_video').val(question_dic.related_video);
$('h2#message').html(question_dic.message);

Perseus.init({skipMathJax: false}).then(function() {

    var editorProps = _.extend(question, {
        problemNum: problemNum,
        enabledFeatures: enabledFeatures,
        developerMode: true,
        imageUploader: function(image, callback) {
            _.delay(callback, 1000, "http://fake.image.url");
        },
        apiOptions: {
            __onInputError: function() {
                var args = _.toArray(arguments);
                console.log.apply(console, ["onInputError:"].concat(args));
                return false;
            },
            __interceptInputFocus: function() {
                var args = _.toArray(arguments);
                console.log.apply(console, ["interceptInputFocus:"].concat(args));
                return;
            }
        }
    });

    editor = React.renderComponent(
        Perseus.StatefulEditorPage(editorProps, null),
        document.getElementById("perseus-container")
    );

    // Some hacks to make debugging nicer
    window.editorPage = editor.refs.editor;
    window.itemRenderer = window.editorPage.renderer;
}).then(function() {
}, function(err) {
    console.error(err);
});

}

})();
</script>

</body>
</html>
